<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>WebAR â€” Image Scan â†’ Spawn 3D Model (Stays)</title>

  <!-- ESM imports (same method as your working file) -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
      "mindar-image-three": "https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"
    }
  }
  </script>

  <style>
    html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    #container{position:fixed;inset:0}
    /* MindAR camera <video> behind the WebGL canvas */
    #container video{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
    #container canvas{position:fixed;inset:0;z-index:1}
    #hint{position:fixed;left:0;right:0;top:10px;text-align:center;color:#fff;opacity:.9;z-index:3}
    #ui{position:fixed;left:12px;right:12px;bottom:12px;z-index:4;display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    button,a.button{padding:10px 14px;border:0;border-radius:12px;font-size:16px;font-weight:600;cursor:pointer;background:#4f46e5;color:#fff;text-decoration:none}
    button.secondary{background:#374151}
  </style>
</head>
<body>
  <div id="hint">Point your camera at the target image</div>
  <div id="container"></div>

  <div id="ui">
    <button id="startBtn">Start AR</button>
    <button id="restartBtn" class="secondary">Restart</button>
    <a id="ctaBtn" class="button" href="#" target="_blank" rel="noopener">Visit Site</a>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { MindARThree } from 'mindar-image-three';

    // ðŸ‘‰ Set your website here
    const CTA_URL = 'https://example.com';
    document.getElementById('ctaBtn').href = CTA_URL;

    // ðŸ‘‰ Set your model path here
    const MODEL_URL = './model.glb';

    const container  = document.getElementById('container');
    const startBtn   = document.getElementById('startBtn');
    const restartBtn = document.getElementById('restartBtn');
    const hint       = document.getElementById('hint');

    // MindAR init (same as your reference)
    const mindar = new MindARThree({
      container,
      imageTargetSrc: './targets.mind',
      uiLoading:'no', uiScanning:'no', uiError:'no',
      warmupTolerance: 2, missTolerance: 8
    });
    const { renderer, scene, camera } = mindar;
    renderer.setClearColor(0x000000, 0);
    renderer.domElement.style.touchAction = 'none';

    // Lighting for 3D model (video didnâ€™t need this, models do)
    scene.add(new THREE.AmbientLight(0xffffff, 0.8));
    const dir = new THREE.DirectionalLight(0xffffff, 0.8);
    dir.position.set(1, 2, 1);
    scene.add(dir);

    // Anchor for target index 0
    const anchor = mindar.addAnchor(0);

    // A parent in world-space where weâ€™ll place the model once, then â€œlockâ€ it there
    const worldRoot = new THREE.Group();
    scene.add(worldRoot);

    // Model loading
    const loader = new GLTFLoader();
    let modelPrefab = null;   // loaded GLTF scene (template)
    let modelInstance = null; // the actually spawned instance
    let spawned = false;      // prevent duplicate spawns

    // Preload the model
    loader.load(MODEL_URL, (gltf) => {
      modelPrefab = gltf.scene;
      // Optional: normalize initial scale if your model is huge/tiny
      modelPrefab.scale.set(1,1,1);
      // Donâ€™t add to scene yet; weâ€™ll clone on detection
    }, undefined, (err) => {
      console.error('Failed to load model:', err);
    });

    // Utility: copy current anchor world transform into worldRoot
    const tmpPos = new THREE.Vector3();
    const tmpQuat = new THREE.Quaternion();
    const tmpScale = new THREE.Vector3();

    function lockWorldTransformToAnchor() {
      // Ensure world matrices are up to date
      anchor.group.updateWorldMatrix(true, true);

      anchor.group.getWorldPosition(tmpPos);
      anchor.group.getWorldQuaternion(tmpQuat);
      anchor.group.getWorldScale(tmpScale);

      worldRoot.position.copy(tmpPos);
      worldRoot.quaternion.copy(tmpQuat);
      worldRoot.scale.copy(tmpScale);
      worldRoot.updateMatrixWorld(true);
    }

    // When target is found the first time â†’ spawn and lock
    anchor.onTargetFound = () => {
      hint.textContent = 'Tracking âœ“';
      if (!spawned && modelPrefab) {
        // 1) Lock a world-space pivot where the target is
        lockWorldTransformToAnchor();

        // 2) Clone and place the model under that world pivot
        modelInstance = modelPrefab.clone(true);
        worldRoot.add(modelInstance);

        // 3) Mark as spawned so it persists and doesnâ€™t duplicate
        spawned = true;
        hint.textContent = 'Placed âœ“ You can move away.';
      } else if (!spawned && !modelPrefab) {
        // Model not yet loaded but target found; try again next time
        hint.textContent = 'Tracking âœ“ (loading model...)';
      }
    };

    // When target is lost â†’ do nothing; the model stays
    anchor.onTargetLost = () => {
      if (spawned) {
        hint.textContent = 'Model placed â€” move around freely';
      } else {
        hint.textContent = 'Move back to the targetâ€¦';
      }
    };

    // Buttons
    restartBtn.addEventListener('click', async () => {
      try { await mindar.stop(); } catch {}
      // Clear any existing render loop (safety)
      renderer.setAnimationLoop(null);

      // (Optional) If you want a fresh placement each restart:
      // scene.remove(worldRoot);
      // worldRoot.clear();
      // scene.add(worldRoot);
      // spawned = false;
      // modelInstance = null;

      await mindar.start();
      renderer.setAnimationLoop(() => renderer.render(scene, camera));
      hint.textContent = 'Point your camera at the target image';
    });

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true; startBtn.textContent = 'Startingâ€¦';
      try {
        await mindar.start();                          // triggers camera prompt
        renderer.setAnimationLoop(()=>renderer.render(scene, camera));
        startBtn.textContent = 'Runningâ€¦';
      } catch (e) {
        console.error(e);
        startBtn.disabled = false; startBtn.textContent = 'Start AR (Retry)';
      }
    });

    // Keep renderer sized to container (same as reference)
    const ro = new ResizeObserver(() => {
      renderer.setSize(container.clientWidth, container.clientHeight, false);
    });
    ro.observe(container);
  </script>
</body>
</html>
